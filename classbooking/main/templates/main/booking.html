{% extends "main/master/index.html" %}
<!---->
{% block title %}
  Bookings
{% endblock title %}
<!---->
{% block content %}
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="content-card">
          <h2>Classroom Booking</h2>
          <div class="card-body mt-4">
            {% if not edit_mode %}
              {% if request.user.is_staff %}
                <!-- Admin bookings -->
                <h5>Manage Bookings</h5>
              {% else %}
                <!-- User's current bookings -->
                <h5>Your Current Bookings</h5>
              {% endif %}
              {% if bookings %}
                <div class="table-responsive mb-4">
                  <table class="table table-striped table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th>Classroom</th>
                        <th>Room No.</th>
                        <th>Start</th>
                        <th>End</th>
                        {% if request.user.is_staff %}<th>Booked by</th>{% endif %}
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for b in bookings %}
                        <tr>
                          <td>{{ b.classroom.name }}</td>
                          <td>{{ b.classroom.room_number }}</td>
                          <td>{{ b.start_time|date:"Y-m-d H:i" }}</td>
                          <td>{{ b.end_time|date:"Y-m-d H:i" }}</td>
                          {% if request.user.is_staff %}<td>{{ b.user.username }}</td>{% endif %}
                          <td>
                            <a href="{% url 'booking_edit' b.id %}" class="btn btn-sm btn-primary">แก้ไข</a>
                            <a href="{% url 'booking_cancel' b.id %}" class="btn btn-sm btn-danger">ยกเลิก</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                {% if request.user.is_staff %}
                  <!-- Admin bookings -->
                  <p class="text-muted mb-4">No bookings at the moment.</p>
                {% else %}
                  <!-- Users bookings -->
                  <p class="text-muted mb-4">You have no current bookings.</p>
                {% endif %}
              {% endif %}
              <!-- Booking form -->
              <h5>Reserve a Classroom</h5>
              {% load crispy_forms_tags %}
              <form method="post" novalidate>
                {% csrf_token %}
                {{ form | crispy }}
                <!-- Submit -->
                <div class="d-grid mt-3">
                  <button type="submit" class="btn btn-success btn-lg">Book Classroom</button>
                </div>
              </form>
            {% else %}
              <h5>Edit a Classroom</h5>
              {% load form_tags %}
              <form method="post" novalidate>
                {% csrf_token %}
                <!-- Error -->
                {% if form.non_field_errors %}
                  <div class="alert alert-block alert-danger">
                    <ul class="m-0">
                      {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                  </div>
                {% endif %}
                <!-- Classroom (pre-selected) -->
                <div class="mb-3">
                  <label for="{{ form.classroom.id_for_label }}" class="form-label">Classroom</label>
                  <select name="classroom"
                          class="form-control"
                          required
                          id="id_classroom"
                          disabled>
                    <option value="">{{ current_booking_name }}</option>
                  </select>
                </div>
                <!-- Start time -->
                <div class="mb-3">
                  <label for="{{ form.start_time.id_for_label }}" class="form-label">Start Time</label>
                  {{ form.start_time|add_class:"form-control" }}
                  {% if form.start_time.errors %}<div class="text-danger small">{{ form.start_time.errors.0 }}</div>{% endif %}
                </div>
                <!-- End time -->
                <div class="mb-3">
                  <label for="{{ form.end_time.id_for_label }}" class="form-label">End Time</label>
                  {{ form.end_time|add_class:"form-control" }}
                  {% if form.end_time.errors %}<div class="text-danger small">{{ form.end_time.errors.0 }}</div>{% endif %}
                </div>
                <!-- Submit -->
                <div class="d-grid mt-3">
                  <button type="submit" class="btn btn-success btn-lg">Confirm Edit</button>
                </div>
                <!-- Cancel -->
                <div class="d-grid mt-3">
                  <a href="{% url 'booking' %}"
                     type="button"
                     class="btn btn-danger btn-lg">Cancel Edit</a>
                </div>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
